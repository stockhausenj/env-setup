---
- name: Install Java 21 JDK via Homebrew (macOS)
  community.general.homebrew_cask:
    name: temurin@21
    state: present
  when: ansible_os_family == "Darwin"

- name: Download and install OpenJDK 21 (Linux)
  when: ansible_os_family != "Darwin"
  block:
    - name: Get latest Java 21 download URL
      shell: |
        curl -s https://jdk.java.net/21/ | grep -o 'https://download.java.net/java/GA/jdk21[^"]*linux-x64[^"]*tar.gz' | head -n1
      register: jdk_download_url
      changed_when: false

    - name: Download and extract JDK 21
      unarchive:
        src: "{{ jdk_download_url.stdout }}"
        dest: /opt/
        remote_src: yes
      become: true
      when: jdk_download_url.stdout != ""

- name: Install Maven via Homebrew (macOS)
  community.general.homebrew:
    name: maven
    state: present
  when: ansible_os_family == "Darwin"

- name: Download and install Maven (Linux)
  when: ansible_os_family != "Darwin"
  block:
    - name: Get latest Maven version
      shell: |
        curl -s https://maven.apache.org/download.cgi | grep -oP 'apache-maven-\d+\.\d+\.\d+-bin.tar.gz' | head -n1
      register: maven_filename
      changed_when: false

    - name: Download Maven
      get_url:
        url: "https://dlcdn.apache.org/maven/maven-3/{{ maven_filename.stdout }}"
        dest: "/tmp/{{ maven_filename.stdout }}"
        mode: '0644'
      when: maven_filename.stdout != ""

    - name: Extract Maven
      unarchive:
        src: "/tmp/{{ maven_filename.stdout }}"
        dest: /opt/
        remote_src: yes
      become: true
      when: maven_filename.stdout != ""

    - name: Create Maven symlink
      file:
        src: "/opt/{{ maven_filename.stdout | regex_replace('-bin\\.tar\\.gz$', '') }}"
        dest: /opt/maven
        state: link
      become: true
      when: maven_filename.stdout != ""

- name: Ensure .sources directory exists
  file:
    path: "{{ ansible_facts['env']['HOME'] }}/.sources"
    state: directory
    mode: '0755'

- name: Configure JAVA_HOME for macOS
  template:
    src: jdk-21-source-macos.j2
    dest: "{{ ansible_facts['env']['HOME'] }}/.sources/java"
    mode: '0644'
  when: ansible_os_family == "Darwin"

- name: Configure JAVA_HOME for Linux
  template:
    src: jdk-21-source-linux.j2
    dest: "{{ ansible_facts['env']['HOME'] }}/.sources/java"
    mode: '0644'
  when: ansible_os_family != "Darwin"

# Maven Configuration
- name: Ensure .m2 directory exists
  file:
    path: "{{ ansible_facts['env']['HOME'] }}/.m2"
    state: directory
    mode: '0755'

- name: Create Maven settings.xml
  copy:
    dest: "{{ ansible_facts['env']['HOME'] }}/.m2/settings.xml"
    content: |
      <?xml version="1.0" encoding="UTF-8"?>
      <settings xmlns="http://maven.apache.org/SETTINGS/1.0.0"
                xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                xsi:schemaLocation="http://maven.apache.org/SETTINGS/1.0.0
                                    https://maven.apache.org/xsd/settings-1.0.0.xsd">

        <!-- Local repository location -->
        <localRepository>${user.home}/.m2/repository</localRepository>

        <!-- Offline mode -->
        <offline>false</offline>

        <!-- Plugin groups -->
        <pluginGroups>
          <pluginGroup>org.apache.maven.plugins</pluginGroup>
          <pluginGroup>org.codehaus.mojo</pluginGroup>
        </pluginGroups>

        <!-- Mirrors (uncomment and configure as needed) -->
        <!--
        <mirrors>
          <mirror>
            <id>central-mirror</id>
            <name>Maven Central Mirror</name>
            <url>https://repo1.maven.org/maven2</url>
            <mirrorOf>central</mirrorOf>
          </mirror>
        </mirrors>
        -->

        <!-- Profiles -->
        <profiles>
          <profile>
            <id>default</id>
            <properties>
              <maven.compiler.source>21</maven.compiler.source>
              <maven.compiler.target>21</maven.compiler.target>
              <project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>
            </properties>
          </profile>
        </profiles>

        <!-- Active profiles -->
        <activeProfiles>
          <activeProfile>default</activeProfile>
        </activeProfiles>

      </settings>
    mode: '0644'
    force: no

# VSCode Configuration
- name: Ensure VSCode settings directory exists (macOS)
  file:
    path: "{{ ansible_facts['env']['HOME'] }}/Library/Application Support/Code/User"
    state: directory
    mode: '0755'
  when: ansible_os_family == "Darwin"

- name: Configure VSCode Java settings (macOS)
  copy:
    dest: "{{ ansible_facts['env']['HOME'] }}/Library/Application Support/Code/User/java-settings.json"
    content: |
      {
        "java.configuration.runtimes": [
          {
            "name": "JavaSE-21",
            "path": "/Library/Java/JavaVirtualMachines/temurin-21.jdk/Contents/Home",
            "default": true
          }
        ],
        "java.home": "/Library/Java/JavaVirtualMachines/temurin-21.jdk/Contents/Home",
        "java.jdt.ls.java.home": "/Library/Java/JavaVirtualMachines/temurin-21.jdk/Contents/Home"
      }
    mode: '0644'
  when: ansible_os_family == "Darwin"

# Neovim (LazyVim) Configuration
- name: Ensure Neovim plugins directory exists
  file:
    path: "{{ ansible_facts['env']['HOME'] }}/.config/nvim/lua/plugins"
    state: directory
    mode: '0755'

- name: Configure Neovim Java LSP
  copy:
    src: java-lsp.lua
    dest: "{{ ansible_facts['env']['HOME'] }}/.config/nvim/lua/plugins/java-lsp.lua"
    mode: '0644'

- name: Ensure Mason packages directory exists
  file:
    path: "{{ ansible_facts['env']['HOME'] }}/.local/share/nvim/mason/packages/jdtls"
    state: directory
    mode: '0755'

- name: Download Lombok JAR for Neovim LSP
  get_url:
    url: "https://projectlombok.org/downloads/lombok.jar"
    dest: "{{ ansible_facts['env']['HOME'] }}/.local/share/nvim/mason/packages/jdtls/lombok.jar"
    mode: '0644'
    timeout: 30
  ignore_errors: yes

# IntelliJ Configuration (via JetBrains Toolbox or standalone)
- name: Create IntelliJ IDEA options directory (macOS)
  file:
    path: "{{ ansible_facts['env']['HOME'] }}/Library/Application Support/JetBrains/IntelliJIdea{{ intellij_version | default('2024.1') }}/options"
    state: directory
    mode: '0755'
  when: ansible_os_family == "Darwin"
  ignore_errors: yes

- name: Configure IntelliJ IDEA JDK (macOS)
  copy:
    dest: "{{ ansible_facts['env']['HOME'] }}/Library/Application Support/JetBrains/IntelliJIdea{{ intellij_version | default('2024.1') }}/options/jdk.table.xml"
    content: |
      <application>
        <component name="ProjectJdkTable">
          <jdk version="2">
            <name value="temurin-21" />
            <type value="JavaSDK" />
            <version value="java version &quot;21&quot;" />
            <homePath value="/Library/Java/JavaVirtualMachines/temurin-21.jdk/Contents/Home" />
          </jdk>
        </component>
      </application>
    mode: '0644'
  when: ansible_os_family == "Darwin"
  ignore_errors: yes

# Verification and Helper Tools
- name: Ensure ~/bin directory exists
  file:
    path: "{{ ansible_facts['env']['HOME'] }}/bin"
    state: directory
    mode: '0755'

- name: Copy Java verification script
  copy:
    src: verify-java-setup.sh
    dest: "{{ ansible_facts['env']['HOME'] }}/bin/verify-java-setup"
    mode: '0755'

- name: Ensure ~/bin is in PATH
  lineinfile:
    path: "{{ ansible_facts['env']['HOME'] }}/.zshrc"
    line: 'export PATH="$HOME/bin:$PATH"'
    regexp: '^export PATH="\$HOME/bin:\$PATH"'
    state: present
  when: ansible_os_family == "Darwin"

- name: Copy VSCode Java extensions recommendations
  copy:
    src: vscode-java-extensions.json
    dest: "{{ ansible_facts['env']['HOME'] }}/vscode-java-extensions.json"
    mode: '0644'

- name: Display post-installation message
  debug:
    msg:
      - "Java 21 and Maven installation complete!"
      - ""
      - "Next steps:"
      - "1. Reload your shell: source ~/.zshrc"
      - "2. Verify installation: verify-java-setup"
      - "3. Check versions:"
      - "   - Java: java -version"
      - "   - Maven: mvn -version"
      - "4. Install VSCode extensions: cat ~/vscode-java-extensions.json | jq -r '.recommendations[]' | xargs -L 1 code --install-extension"
      - ""
      - "Maven:"
      - "  - Configuration: ~/.m2/settings.xml"
      - "  - Default compiler: Java 21"
      - "  - Repository: ~/.m2/repository"
      - ""
      - "For Neovim:"
      - "  - Open a .java file and LSP will auto-attach"
      - "  - Use :Mason to verify jdtls is installed"
      - "  - Lombok support is enabled (lombok.jar included)"
      - ""
      - "Documentation: {{ ansible_facts['env']['HOME'] }}/env-setup/roles/java/README.md"
